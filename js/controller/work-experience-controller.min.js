import{WorkExperienceModel}from"../model/work-experience-model.min.js";import{Utility}from"../shared/utility.min.js";import ScriptSeriesLoader from"../shared/script-series-loader.min.js";class WorkExperienceController{constructor(){this.model=new WorkExperienceModel,this.scriptLoader=ScriptSeriesLoader,this.scriptLoader.add("https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.min.js"),this.scriptLoader.load()}static build=async()=>{const e=new WorkExperienceController;for(;e.scriptLoader.running;)await Utility.sleep(2e3);return e};execute=()=>{let e=this.model.getWorkExperiences(),r=this.getLoadedMinNumber(),t=!1;if(!r){r=e.map((e=>e.no)).reduce(((e,r)=>Math.max(e,r)))+1,t=!0}const o=this.getNextLoadingNumbers(r,5);1===o.reduce(((e,r)=>Math.min(e,r)))&&$("#work-experience-additional-loading-bar").hide(),e=e.filter((e=>o.includes(Number(e.no))));const s=[];for(const r of e){const e=[];e.push(this.createNoTd(r)),e.push(this.createBusinessTypeTd(r)),e.push(this.createWorkingPeriodTd(r)),e.push(this.createTechnologyTd(r)),e.push(this.createMainTask(r)),e.push(this.createTaskType(r)),e.push(this.createReportLinkTd(r));const t=$(`<tr>${e.join("")}</tr>`);s.push(t)}t?s.forEach((e=>$("#work-experience tr:last").after(e))):this.appendRowsWithAnimation(s)};appendRowsWithAnimation=e=>{const r=()=>{if(0===e.length)return;const t=e.shift();$("#work-experience tr:last").after(t),t.find("td").wrapInner("<div style='display:none;' />").parent().find("td > div").slideDown("slow",(function(){const e=$(this);e.replaceWith(e.contents()),r()}))};r()};getLoadedMinNumber=()=>{const e=[];for(let r of $(".work-experience-number")){const t=Number(r.outerText);e.push(t)}if(0===e.length)return null;return e.reduce(((e,r)=>Math.min(e,r)))};getNextLoadingNumbers=(e,r)=>{let t=[];for(let o=0;o<r;o++){const r=e-(o+1);if(r<1)break;t.push(r)}return t};createTd=(e,r)=>`<td class='${e}'>${r}</td>`;createNoTd=e=>this.createTd("work-experience-number",`<p>${e.no}</p>`);createBusinessTypeTd=e=>{const r=[];r.push("サービス"),r.push("メーカー");let t=e.businessType;for(const o of r)-1!==e.businessType.indexOf(o)&&(t=t.replace(o,`<br>${o}`));return this.createTd("work-experience-business-type",`<p>${t}</p>`)};createWorkingPeriodTd=e=>{const r="work-experience-working-period",t=(e,t)=>`<p class='${r}-${e}'>${t}</p>`,o=r=>{if(!e.period[r])return;const o=e.period[r].split("-");if(!o[0]||!o[1])return;let s=`${o[0]}年${o[1]}月`;return t(r,s)},s=[];return s.push(o("from")),s.push(t("between","～")),s.push(o("to")),this.createTd(r,s.join(""))};createTechnologyTd=e=>{const r="work-experience-technology",t=(e,t)=>{if(!t||0===t.length)return;const o=t.filter(((e,r,t)=>t.indexOf(e)===r)),s=[];for(const t of o){const o=(e,t)=>`<p class='${r}-${e}'>${t}</p>`;s.push(o(e,t))}return s.join("")},o=[];return o.push(t("device",e.device)),o.push(t("operating-system",e.os)),o.push(t("programming-language",e.programLanguage)),o.push(t("development-tool",e.developmentTool)),o.push(t("database",e.db)),o.push(t("framework",e.framework)),o.push(t("platform",e.platform)),o.push(t("uncategorized",e.uncategorizedTechnology)),this.createTd(r,o.join(""))};createMainTask=e=>{const r="work-experience-main-task";if(!e.task||0===e.task.length)return this.createTd(r,"");const t=(e,t)=>`<p class='${r}-${e}'>${t}</p>`,o=[];o.push(t("summary",e.projectSummary));for(const r of e.task)o.push(t("name",r.name));return this.createTd(r,o.join(""))};createTaskType=e=>{const r="work-experience-task-type";if(!e.task||0===e.task.length)return this.createTd(r,"");let t=[];e.task.forEach((e=>t=t.concat(e.type))),t=t.filter(((e,r,t)=>t.indexOf(e)===r)),t=this.model.getSortedTaskTypeIds(t);const o=(e,t,o)=>`<p class='${r}-${e}' style='${t}'>${o}</p>`,s=[];for(const e of t){if(""===e)continue;const r=this.model.getTaskThemeByTaskTypeId(e),t=[];t.push(r?`color:${r.foreColor}`:""),t.push(r?`background-color:${r.backgroundColor}`:""),s.push(o("unknown",t.join(";"),e))}return this.createTd(r,s.join(""))};createReportLinkTd=e=>{const r=`work-experience\\report.html?no=${e.no}`;return this.createTd("work-experience-report-link",`<a href='${r}'><img style='width:90%;' src='icon/top-to-right-arrow-in-box.svg'></a>`)}}export{WorkExperienceController};