import{Buildable}from"../interface/buildable.min.js";import{WorkExperienceModel}from"../model/work-experience-model.min.js";import{Utility}from"../shared/utility.min.js";import ScriptSeriesLoader from"../shared/script-series-loader.min.js";class WorkExperienceController extends Buildable{constructor(){this.model=new WorkExperienceModel,this.scriptLoader=ScriptSeriesLoader,this.scriptLoader.add("https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"),this.scriptLoader.load()}static build=async()=>{const e=new WorkExperienceController;for(;e.scriptLoader.running;)await Utility.sleep(2e3);return e};execute=()=>{let e=this.model.getWorkExperiences(),t=this.getLoadedMinNumber(),r=!1;if(!t){t=e.map((e=>e.no)).reduce(((e,t)=>Math.max(e,t)))+1,r=!0}const o=this.getNextLoadingNumbers(t,5);1===o.reduce(((e,t)=>Math.min(e,t)))&&$("#work-experience-additional-loading-bar").hide(),e=e.filter((e=>o.includes(Number(e.no))));const s=[];for(const t of e){const e=[];e.push(this.createNoTd(t)),e.push(this.createBusinessTypeTd(t)),e.push(this.createWorkingPeriodTd(t)),e.push(this.createTechnologyTd(t)),e.push(this.createMainTask(t)),e.push(this.createTaskType(t)),e.push(this.createReportLinkTd(t));const r=$(`<tr>${e.join("")}</tr>`);s.push(r)}r?s.forEach((e=>$("#work-experience > tbody").append(e))):this.appendRowsWithAnimation(s)};appendRowsWithAnimation=e=>{const t=()=>{if(0===e.length)return;const r=e.shift();$("#work-experience > tbody").append(r),r.find("td").wrapInner("<div style='display:none;' />").parent().find("td > div").slideDown("slow",(function(){const e=$(this);e.replaceWith(e.contents()),t()}))};t()};getLoadedMinNumber=()=>{const e=[];for(let t of $(".work-experience-number")){const r=Number(t.outerText);e.push(r)}if(0===e.length)return null;return e.reduce(((e,t)=>Math.min(e,t)))};getNextLoadingNumbers=(e,t)=>{let r=[];for(let o=0;o<t;o++){const t=e-(o+1);if(t<1)break;r.push(t)}return r};createTd=(e,t)=>`<td class='${e}'>${t}</td>`;createNoTd=e=>this.createTd("work-experience-number",`<p>${e.no}</p>`);createBusinessTypeTd=e=>{const t=[];t.push("サービス"),t.push("メーカー");let r=e.businessType;for(const o of t)-1!==e.businessType.indexOf(o)&&(r=r.replace(o,`<br>${o}`));return this.createTd("work-experience-business-type",`<p>${r}</p>`)};createWorkingPeriodTd=e=>{const t="work-experience-working-period",r=(e,r)=>`<p class='${t}-${e}'>${r}</p>`,o=t=>{if(!e.period[t])return;const o=e.period[t].split("-");if(!o[0]||!o[1])return;let s=`${o[0]}年${o[1]}月`;return r(t,s)},s=[];return s.push(o("from")),s.push(r("between","～")),s.push(o("to")),this.createTd(t,s.join(""))};createTechnologyTd=e=>{const t="work-experience-technology",r=(e,r)=>{if(!r||0===r.length)return;const o=r.filter(((e,t,r)=>r.indexOf(e)===t)),s=[];for(const r of o){const o=(e,r)=>`<p class='${t}-${e}'>${r}</p>`;s.push(o(e,r))}return s.join("")},o=[];return o.push(r("device",e.device)),o.push(r("operating-system",e.os)),o.push(r("programming-language",e.programmingLanguage)),o.push(r("development-tool",e.developmentTool)),o.push(r("database",e.database)),o.push(r("framework",e.framework)),o.push(r("platform",e.platform)),o.push(r("uncategorized",e.uncategorizedTechnology)),this.createTd(t,o.join(""))};createMainTask=e=>{const t="work-experience-main-task";if(!e.task||0===e.task.length)return this.createTd(t,"");const r=(e,r)=>`<p class='${t}-${e}'>${r}</p>`,o=[];o.push(r("summary",e.projectSummary));for(const t of e.task)o.push(r("name",t.name));return this.createTd(t,o.join(""))};createTaskType=e=>{const t="work-experience-task-type";if(!e.task||0===e.task.length)return this.createTd(t,"");let r=[];e.task.forEach((e=>r=r.concat(e.type))),r=r.filter(((e,t,r)=>r.indexOf(e)===t)),r=this.model.getSortedTaskTypeIds(r);const o=(e,r,o)=>`<p class='${t}-${e}' style='${r}'>${o}</p>`,s=[];for(const e of r){if(""===e)continue;const t=this.model.getTaskThemeByTaskTypeId(e),r=[];r.push(t?`color:${t.foreColor}`:""),r.push(t?`background-color:${t.backgroundColor}`:""),s.push(o("unknown",r.join(";"),e))}return this.createTd(t,s.join(""))};createReportLinkTd=e=>{const t=`work-experience\\report.html?no=${e.no}`;return this.createTd("work-experience-report-link",`<a href='${t}'><img style='width:90%;' src='icon/top-to-right-arrow-in-box.svg'></a>`)}}export{WorkExperienceController};