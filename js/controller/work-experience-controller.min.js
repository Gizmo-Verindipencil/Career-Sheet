import{createInstance}from"../keyword/create-instance.min.js";import{Buildable}from"../interface/buildable.min.js";import{WorkExperienceModel}from"../model/work-experience-model.min.js";import{Utility}from"../shared/utility.min.js";import{PageColorAdjuster}from"../shared/page-color-adjuster.min.js";import ScriptSeriesLoader from"../shared/script-series-loader.min.js";import StylesheetSeriesLoader from"../shared/stylesheet-series-loader.min.js";class WorkExperienceController extends Buildable{constructor(){super(),this.model=new WorkExperienceModel,this.scriptLoader=ScriptSeriesLoader,this.scriptLoader.add("https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"),this.scriptLoader.load(),this.stylesheetLoader=StylesheetSeriesLoader,this.stylesheetLoader.add("css/destyle.min.css"),this.stylesheetLoader.add("css/restyle.min.css"),this.stylesheetLoader.add("css/common.min.css"),this.stylesheetLoader.add("css/work-experience.min.css"),this.stylesheetLoader.load()}static build=async()=>{const e=new WorkExperienceController;for(;e.scriptLoader.running||e.stylesheetLoader.running;)await Utility.sleep(2e3);return e};execute=async()=>{let e=this.model.getWorkExperiences(),t=this.getLoadedMinNumber(),r=!1;if(!t){t=e.map((e=>e.no)).reduce(((e,t)=>Math.max(e,t)))+1,r=!0}const s=this.getNextLoadingNumbers(t,5);1===s.reduce(((e,t)=>Math.min(e,t)))&&$("#work-experience-additional-loading-bar").hide(),e=e.filter((e=>s.includes(Number(e.no))));const o=[];for(const t of e){const e=[];e.push(this.createNoTd(t)),e.push(this.createBusinessTypeTd(t)),e.push(this.createWorkingPeriodTd(t)),e.push(this.createTechnologyTd(t)),e.push(this.createMainTask(t)),e.push(this.createTaskType(t)),e.push(this.createReportLinkTd(t));const r=$(`<tr>${e.join("")}</tr>`);o.push(r)}r?o.forEach((e=>$("#work-experience > tbody").append(e))):this.appendRowsWithAnimation(o);(await createInstance(PageColorAdjuster)).changeBackgroundColor()};appendRowsWithAnimation=e=>{const t=()=>{if(0===e.length)return;const r=$(e.shift());$("#work-experience > tbody").append(r),r.ready((async()=>{if(0!==e.length)return;(await createInstance(PageColorAdjuster)).changeBackgroundColor()})),r.find("td").wrapInner("<div style='display:none;' />").parent().find("td > div").slideDown("slow",(function(){const e=$(this);e.replaceWith(e.contents()),t()}))};t()};getLoadedMinNumber=()=>{const e=[];for(let t of $(".work-experience-number")){const r=Number(t.outerText);e.push(r)}if(0===e.length)return null;return e.reduce(((e,t)=>Math.min(e,t)))};getNextLoadingNumbers=(e,t)=>{let r=[];for(let s=0;s<t;s++){const t=e-(s+1);if(t<1)break;r.push(t)}return r};createTd=(e,t)=>`<td class='${e}'>${t}</td>`;createNoTd=e=>this.createTd("work-experience-number",`<p>${e.no}</p>`);createBusinessTypeTd=e=>{const t=[];t.push("サービス"),t.push("メーカー");let r=e.businessType;for(const s of t)-1!==e.businessType.indexOf(s)&&(r=r.replace(s,`<br>${s}`));return this.createTd("work-experience-business-type",`<p>${r}</p>`)};createWorkingPeriodTd=e=>{const t="work-experience-working-period",r=(e,r)=>`<p class='${t}-${e}'>${r}</p>`,s=t=>{if(!e.period[t])return;const s=e.period[t].split("-");if(!s[0]||!s[1])return;let o=`${s[0]}年${s[1]}月`;return r(t,o)},o=[];return o.push(s("from")),o.push(r("between","～")),o.push(s("to")),this.createTd(t,o.join(""))};createTechnologyTd=e=>{const t="work-experience-technology",r=(e,r)=>{if(!r||0===r.length)return;const s=r.filter(((e,t,r)=>r.indexOf(e)===t)),o=[];for(const r of s){const s=(e,r)=>`<p class='${t}-${e}'>${r}</p>`;o.push(s(e,r))}return o.join("")},s=[];return s.push(r("device",e.device)),s.push(r("operating-system",e.os)),s.push(r("programming-language",e.programmingLanguage)),s.push(r("development-tool",e.developmentTool)),s.push(r("database",e.database)),s.push(r("framework",e.framework)),s.push(r("platform",e.platform)),s.push(r("uncategorized",e.uncategorizedTechnology)),this.createTd(t,s.join(""))};createMainTask=e=>{const t="work-experience-main-task";if(!e.task||0===e.task.length)return this.createTd(t,"");const r=(e,r)=>`<p class='${t}-${e}'>${r}</p>`,s=[];s.push(r("summary",e.projectSummary));for(const t of e.task)s.push(r("name",t.name));return this.createTd(t,s.join(""))};createTaskType=e=>{const t="work-experience-task-type";if(!e.task||0===e.task.length)return this.createTd(t,"");let r=[];e.task.forEach((e=>r=r.concat(e.type))),r=r.filter(((e,t,r)=>r.indexOf(e)===t)),r=this.model.getSortedTaskTypeIds(r);const s=(e,r,s)=>`<p class='${t}-${e}' style='${r}'>${s}</p>`,o=[];for(const e of r){if(""===e)continue;const t=this.model.getTaskThemeByTaskTypeId(e),r=[];r.push(t?`color:${t.foreColor}`:""),r.push(t?`background-color:${t.backgroundColor}`:""),o.push(s("colorless",r.join(";"),e))}return this.createTd(t,o.join(""))};createReportLinkTd=e=>{const t=`work-experience\\report.html?no=${e.no}`;return this.createTd("work-experience-report-link",`<a href='${t}'><img style='width:90%;' src='icon/top-to-right-arrow-in-box.svg'></a>`)}}export{WorkExperienceController};